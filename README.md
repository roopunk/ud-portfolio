## Project 2

This project has three main components:
1. Recieve data from chrome extension.
2. Fire up R code/application to get related search keywords
3. Fire up node/selenium code to simulate searches for keywords genereated by R code/application

### Setup

#### Requirements

1. Ubuntu 16.04
2. Nginx - `sudo apt-get install nginx`
3. Python3 - `sudo apt-get install python3`
4. Pip3 - `sudo apt install python3-pip`
5. Virtualenv - `sudo pip3 install virtualenv`
6. Mysql - `sudo apt-get install mysql-server && sudo apt-get install libmysqlclient-dev`

#### Running python code

To install the python code, you need to 

1. Cd into the python folder
2. Initiate virtualenv by doing `virtualenv venv`
3. Activate the virtualenv by typing `source venv/bin/activate`
4. Install requirements by doing `pip3 install -r requirements.txt`
5. You can run the process inside screen or with supervisor by `python3 app.py`

### Directory Structure (Relevant ones)


  ```sh
  â”œâ”€â”€ app.py
  â”œâ”€â”€ process_user_keywords.py
  â”œâ”€â”€ process_system_keywords.py
  â”œâ”€â”€ config.py
  â”œâ”€â”€ config_prod.py
  â”œâ”€â”€ README.md
  â”œâ”€â”€ models
  â”‚Â Â  â”œâ”€â”€ keywords.py
  â”œâ”€â”€ repositories
  â”‚Â Â  â”œâ”€â”€ keywords_respository.py
  
  ```

### Files description

**app.py**

Main entrypoint to the application part which listens to chrome extension.
The urls are defined via annotation, like so:
`@app.route('/1.0/gsearch', methods = ['POST'])`

This means any POST request to https://<server_url>/1.0/gsearch will be handles by the following function. `save()` in this case  


**process_user_keywords.py**

Entry point for a request to process a user keyword, as in passing that keyword to R script and saving the corresponding entry into db as system generated keywords.

*limit* : number of keywords fetched per request. Can be changed in keywords_repository.py `get_unprocessed_user_keywords` function. Currently 100.

**process_system_keywords.py**

Entry point for a request to process a system generated keyword, as in passing that keyword to node script which simulates a google search via selenium, clicks on a random link and stores it in db.

*limit* : number of keywords fetched per request. Can be changed in keywords_repository.py `get_unprocessed_system_keywords` function. Currently 100. 

**config.py**

`DEBUG` : basically determines what level of error information will the application log when something failed. It should be fales in production ideally.

`SECRET_KEY`: used internally by flask (the framework we are using) to maintain sessions. This is not used in our case. Since we only have REST apis and no html layer as of now.

`SQLALCHEMY_DATABASE_URI` : mysql connection parameters.

`SQLALCHEMY_ECHO` : prints out sql queries being run when True

`NODE_SCRIPT_PATH` : the path to node script which will fire up selenium

**config_prod.py**

Similar to config.py but used when flask is run in PRODUCTION mode. (Environment variable `MODE` is set to `PRODUCTION`)

**models/keywords.py**

Basically a model of every keyword stored in the db. This model is how python understands the db schema and is able to talk to our db for readin/writing/updating.

**repositories/keywords_respository.py**

Basically a library which talks to db and manages things around keywods. Has the following functions:
1. `add_user_keyword` : For adding a keyword
2. `get_search_by_id` : Search a keyword by it's id
3. `add_bot_keyword` : add a keyword generated by R script
4. `add_bot_keyword_result` : updates the url of the keyword entry which was made by R script after simulating search in selenium
5. `get_unprocessed_user_keywords` : gets keywords search by users to pass on to R script 
6. `get_unprocessed_system_keywords` : gets keywords created by R script whose search will be simulated by selenium.

#### Mysql Database

a. Create a database called `mg-proj2` or if you want to name your database something else, then you can update the same in the python config file `config.py` and change the value of `SQLALCHEMY_DATABASE_URI`
b. Create the keywords table by running the following command:

    CREATE TABLE `keywords` (
      `id` int(11) unsigned NOT NULL AUTO_INCREMENT,
      `keyword` varchar(255) NOT NULL DEFAULT '',
      `site` enum('google','yahoo') DEFAULT NULL,
      `user_system` enum('user','system') DEFAULT NULL,
      `timestamp` bigint(20) DEFAULT NULL,
      `processed` int(11) DEFAULT NULL,
      `success` enum('0','1') DEFAULT NULL,
      `url` text,
      `user_id` varchar(255) DEFAULT NULL,
      `parent_keyword` int(11) DEFAULT NULL,
      PRIMARY KEY (`id`)
    )
